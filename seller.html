<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Seller Dashboard</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f1f5f9;
      padding: 30px;
    }

    .box {
      background: white;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      max-width: 500px;
    }

    input, button, select {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
    }

    button {
      border: none;
      cursor: pointer;
      border-radius: 5px;
      color: white;
    }

    .add { background: #16a34a; }
    .accept { background: #2563eb; }
    .reject { background: #dc2626; }
    .status { background: #7c3aed; }
    .logout { background: #1e293b; }

    li {
      background: #f8fafc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
  </style>
</head>

<body>

  <!-- PRODUCT SECTION -->
  <div class="box">
    <h2>Add Product</h2>
    <input id="productName" placeholder="Product name">
    <input id="productPrice" type="number" placeholder="Price">
    <button class="add" id="addProductBtn">Add Product</button>
  </div>

  <div class="box">
    <h3>Your Products</h3>
    <ul id="productList"></ul>
  </div>

  <!-- ORDER SECTION -->
  <div class="box">
    <h3>Incoming Orders</h3>
    <ul id="orderList"></ul>
  </div>

  <button class="logout" id="logoutBtn">Logout</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      where,
      getDocs,
      doc,
      deleteDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
       apiKey: "AIzaSyBNR5Td6W_7TAjfRhoJzYrGJMgy3Ff_E1Q",
      authDomain: "nexthour-3248f.firebaseapp.com",
      projectId: "nexthour-3248f",
      appId: "1:83247480758:web:27f8f8507273d54ee44b17"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser;

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;
        loadProducts();
        loadOrders();
      }
    });

    // ---------------- PRODUCTS ----------------
    document.getElementById("addProductBtn").onclick = async () => {
      const name = productName.value;
      const price = productPrice.value;

      if (!name || !price) return alert("Fill all fields");

      await addDoc(collection(db, "products"), {
        name,
        price: Number(price),
        sellerId: currentUser.uid,
        createdAt: serverTimestamp()
      });

      productName.value = "";
      productPrice.value = "";
      loadProducts();
    };

    async function loadProducts() {
      const q = query(collection(db, "products"), where("sellerId", "==", currentUser.uid));
      const snap = await getDocs(q);
      productList.innerHTML = "";

      snap.forEach(d => {
        const p = d.data();
        const li = document.createElement("li");
        li.innerHTML = `
          <b>${p.name}</b> – ₹${p.price}
          <button class="reject">Delete</button>
        `;
        li.querySelector("button").onclick = async () => {
          await deleteDoc(doc(db, "products", d.id));
          loadProducts();
        };
        productList.appendChild(li);
      });
    }

    // ---------------- ORDERS ----------------
    async function loadOrders() {
      const q = query(collection(db, "orders"), where("sellerId", "==", currentUser.uid));
      const snap = await getDocs(q);
      orderList.innerHTML = "";

      if (snap.empty) {
        orderList.innerHTML = "<li>No orders yet</li>";
        return;
      }

      snap.forEach(d => {
        const o = d.data();
        const li = document.createElement("li");

        li.innerHTML = `
          <b>${o.productName}</b><br>
          Status: <b>${o.status}</b><br><br>

          ${o.status === "pending" ? `
            <button class="accept">Accept</button>
            <button class="reject">Reject (Out of stock)</button>
          ` : ""}

          ${o.status === "accepted" ? `
            <button class="status">Out for Delivery</button>
          ` : ""}

          ${o.status === "out_for_delivery" ? `
            <button class="status">Mark Delivered</button>
          ` : ""}
        `;

        // BUTTON LOGIC
        const buttons = li.querySelectorAll("button");

        buttons.forEach(btn => {
          btn.onclick = async () => {
            if (btn.innerText.includes("Accept")) {
              await updateDoc(doc(db, "orders", d.id), { status: "accepted" });
            }

            if (btn.innerText.includes("Reject")) {
              await updateDoc(doc(db, "orders", d.id), {
                status: "rejected",
                rejectReason: "Sorry, the product is out of stock"
              });
            }

            if (btn.innerText.includes("Out for Delivery")) {
              await updateDoc(doc(db, "orders", d.id), { status: "out_for_delivery" });
            }

            if (btn.innerText.includes("Delivered")) {
              await updateDoc(doc(db, "orders", d.id), { status: "delivered" });
            }

            loadOrders();
          };
        });

        orderList.appendChild(li);
      });
    }

    // LOGOUT
    logoutBtn.onclick = () => {
      signOut(auth).then(() => window.location.href = "index.html");
    };
  </script>

</body>
</html>
